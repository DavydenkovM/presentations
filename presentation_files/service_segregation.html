<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>service segregation</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="../css/reveal.css">
    <link rel="stylesheet" href="../css/theme/night.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../css/print/pdf.css' : '../css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>


  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Разделение монолита</h1>
          <h3>От проблем к решениям</h3>
          <p>
            <small>Автор: <a href="http://github.com/DavydenkovM">Давыденков Михаил</a> </small>
          </p>
        </section>

        <section>
          <h2>
          Фоксфорд Олимпиада
          </h2>

          <section>
            <ul>
              <li> один из rails engines монолитного приложения (main_app) </li>
              <li> создавалась в сжатые сроки и решено было реализовать её как engine, чтобы использовать наследние main app и уложиться в deadline </li>
            </ul>
          </section>

          <section>
            <h3>
            Плюсы энджина
            <br>
            </h3>
            <ul>
              <li> реюз стилей, форм, компонент main_app, гео и пользовательсокй базы </li>
            </ul>
          </section>

          <section>
            <h3>
            Минусы энджина
            </h3>

            <br>
            <ul>
              <li> С другой стороны - в олимпиадe гораздо активнее идёт запись в базу нежели в main_app (read vs writes), и было бы логичнее держать этот domain в отдельной базе </li>
            </ul>
          </section>

          <section>
            <h3>
            Больше минусов
            </h3>

            <br>
            <ul>
              <li> Со временем таблицы и модели главного приложения засоряются olymp-specific данными (перемешивание контекстов) </li>
              <li> Отсутствует независимый деплой </li>
              <li> Зависимость от версий гемов и подходов главного приложения </li>
              <li> Затягивается тестирование </li>
            </ul>
          </section>
        </section>

        <section>
          <h2>
          Зависимости олимпиад
          </h2>

          <ul>
            <li> Связи пользователя (с олимпиадой, с номером класса, со школой и геобазой) </li>
            <li> Сертификаты и ачивки наследуются от main_app классов </li>
            <li> Рейтинг с джойнами users и школы/геобазы </li>
            <li> Расшаренная геобаза </li>
            <li> Авторизация </li>
            <li> Реюз вьюх и компонентов </li>
          </ul>
        </section>

        <section>
          <h2>
          Проблем много, но все они решаемы
          </h2>
        </section>

        <section>
          <p>
          Реюз вьюх и компонентов
          </p>
          <section>
            <a href="http://dreamingechoes.github.io/gem/ruby/rails/gemify-your-assets-in-less-than-10-minutes">Как завернуть ассеты в гем</a>
            <pre><code class="js">
              $(document).ready(function(){
                // Set debug mode (for console logs)
                RandomGiphyImageRails.debug = true;

                // Testing api key by default if you don't specify one
                RandomGiphyImageRails.data.api_key = 'YOUR_GIPHY_API_KEY';

                // Class of the HTML element where you want to put the gif
                RandomGiphyImageRails.data.element_class = 'giphyme';

                // Query or tag of your random gif
                RandomGiphyImageRails.data.query = 'nintendo';

                // Executes the random gif thing
                RandomGiphyImageRails.giphyme();
              });
            </code></pre>

            <pre><code class="html">
              body
                .giphyme
            </code></pre>
          </section>

          <section>
            <a href="http://dreamingechoes.github.io/gem/ruby/rails/gemify-your-assets-in-less-than-10-minutes">Как завернуть ассеты в гем</a>

            <pre><code class="bash">
            $ bundle gem random_giphy_image_rails

            .
            ├── Gemfile
            ├── lib
            │   ├── timeago
            │   │   └── rails
            │   │           └── version.rb
            │   └── rails.rb
            ├── LICENSE.txt
            ├── Rakefile
            ├── README.md
            └── random_giphy_image_rails.gemspec
            </code></pre>
          </section>

          <section>
            <a href="http://dreamingechoes.github.io/gem/ruby/rails/gemify-your-assets-in-less-than-10-minutes">Как завернуть ассеты в гем</a>

            <pre><code class="ruby">
              require "random_giphy_image_rails/version"

              module RandomGiphyImageRails
                module Rails
                  class Engine < ::Rails::Engine
                  end
                end
              end
            </code></pre>
          </section>


          <section>
            <a href="http://dreamingechoes.github.io/gem/ruby/rails/gemify-your-assets-in-less-than-10-minutes">Как завернуть ассеты в гем</a>

            <pre><code class="shell">
              .
              ├── Gemfile
              ├── lib
              │   ├── timeago
              │   │   └── rails
              │   │           └── version.rb
              │   └── rails.rb
              ├── LICENSE.txt
              ├── Rakefile
              ├── README.md
              └── random_giphy_image_rails.gemspec
              └── vendor
                      └── assets
                               ├── images
                               ├── javascripts
                               │             └── random_giphy_image_rails.js
                               └── stylesheets
            </code></pre>
          </section>

          <section>
            <a href="http://dreamingechoes.github.io/gem/ruby/rails/gemify-your-assets-in-less-than-10-minutes">Как завернуть ассеты в гем</a>

            <pre><code class="ruby">
              $ rake release
              gem 'random_giphy_image_rails'
              bundle
              //= require random_giphy_image_rails
            </code></pre>
          </section>

          <section>
            <p>
            Используя такой подход в энджинах можно использовать сборщики JS модулей (browserify, webpack), писать компоненты на ES6, тестировать и тд. практически независимо от main_app
            </p>

            <p>
            Когда будет сформировано достаточно гемов можно легко организовать библиотеку компонентов отдельным проектом
            </p>
          </section>

          <section>
            <p>
            Альтернатива - организация фронтенд компонентов в виде npm модулей (см. гем browserify-rails)
            </p>
          </section>
        </section>

        <section>
          <h2>
          Авторизация
          </h2>
          <p>
          Уже реализован сервис, нужно только запланировать его внедрение (на самом деле не самая срочная задача)
          </p>
        </section>

        <section>
          <h2>
          Геобаза
          </h2>
          <p>
          Кандидат на самостоятельный API (geobase.foxford.ru)
          </p>
        </section>

        <section>
          <section>
            <img width="1000" height="600" data-src="service_segregation/olymp_joins.png" alt="arch1">
          </section>
          <section>
            <h2>
              Джойны
            </h2>
            <p>
            В postgres существует несколько database decoupling подходов
            </p>

            <ul>
              <li> Денормализация данных (не везде возможно и сложно в нашем случае) </li>
              <li> Foreign Data Wrappers (Postgres MED) и MatView</li>
              <li> Поиск MapReduce решений для Postgresql и MatView</li>
            </ul>
          </section>

          <section>
            <img width="1000" height="600" data-src="service_segregation/fdw.png" alt="arch1">
          </section>

          <section>
            <img width="1000" height="600" data-src="service_segregation/fdw_joins_schema.png" alt="arch1">
          </section>

          <section>
            <pre><code class="sql">
              CREATE DATABASE stoege_development2 WITH OWNER stoege;
              \c stoege_development2

              CREATE TABLE foreign_olymp_user_olympiads(
              id INT PRIMARY KEY NOT NULL,
              user_id INT NOT NULL,
              olympiad_ID INT NOT NULL,
              state CHAR(50),
              position INT,
              solved_tasks_count INT,
              created_at timestamp,
              updated_at timestamp);

              INSERT INTO foreign_olymp_user_olympiads VALUES (
              2989, 224485, 32, 'finished', NUL);

              CREATE EXTENSION postgres_fdw;

              CREATE SERVER localhost
              FOREIGN DATA WRAPPER postgres_fdw
              OPTIONS(host 'localhost', port '5432', dbname 'stoege_development2');

              CREATE USER MAPPING FOR public SERVER
              localhost
              OPTIONS (user 'stoege', password 'dsfafafaf');

              \c stoege_development

              CREATE FOREIGN TABLE foreign_olymp_user_olympiads (id integer, user_id integer, olympiad_id integer, state char(50), position integer, solved_tasks_count integer, created_at timestamp, updated_at timestamp) SERVER localhost OPTIONS(table_name 'foreign_olymp_user_olympiads');

              \dt;
              \det;

              SELECT * FROM users INNER JOIN foreign_olymp_user_olympiads ON users.id = foreign_olymp_user_olympiads.user_id;
            </code></pre>
          </section>
        </section>

        <section style="text-align: left;">
          <h1>THE END</h1>
        </section>

      </div>

    </div>

    <script src="../lib/js/head.min.js"></script>
    <script src="../js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: '../lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../plugin/zoom-js/zoom.js', async: true },
          { src: '../plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
